--source include/have_innodb.inc
--source include/have_sequence.inc
--source include/have_debug.inc

call mtr.add_suppression("InnoDB: Can't free the unused segments in system tablespace because a previous shutdown was not with innodb_fast_shutdown=0");
call mtr.add_suppression("InnoDB: Cannot shrink the system tablespace due to Generic error");
call mtr.add_suppression("InnoDB: Cannot shrink the system tablespace due to Data structure corruption");
call mtr.add_suppression("InnoDB: Failed to free the unused segment");

let $restart_parameters=--debug_dbug=d,undo_segment_leak;
--source include/restart_mysqld.inc
SET GLOBAL INNODB_FILE_PER_TABLE=0;
CREATE TABLE t1(f1 INT NOT NULL, f2 INT NOT NULL)ENGINE=InnoDB;
INSERT INTO t1 SELECT seq, seq FROM seq_1_to_4096;
INSERT INTO t1 SELECT seq, seq FROM seq_1_to_4096;
INSERT INTO t1 SELECT seq, seq FROM seq_1_to_4096;
INSERT INTO t1 SELECT seq, seq FROM seq_1_to_4096;
INSERT INTO t1 SELECT seq, seq FROM seq_1_to_4096;
INSERT INTO t1 SELECT seq, seq FROM seq_1_to_4096;
UPDATE t1 SET f1 = f1 + 1 WHERE f1 > 1000;
UPDATE t1 SET f2 = f2 + 1 WHERE f1 > 1000;
UPDATE t1 SET f1 = f2 + 1 WHERE f1 > 1000;
UPDATE t1 SET f2 = f1 + 1 WHERE f1 > 1000;
DELETE FROM t1;
DROP TABLE t1;
SELECT NAME, FILE_SIZE FROM information_schema.innodb_sys_tablespaces WHERE SPACE = 0;
let $shutdown_timeout=0;
let $restart_parameters=--debug_dbug=d,unused_undo_free_fail_1;
--source include/restart_mysqld.inc
SET GLOBAL innodb_file_per_table=0;
SELECT NAME FROM information_schema.innodb_sys_tables WHERE SPACE = 0;
CREATE TABLE t1(f1 INT NOT NULL)ENGINE=InnoDB;

let $shutdown_timeout=;
set global innodb_fast_shutdown=0;
let $restart_parameters=--debug_dbug=d,unused_undo_free_fail_2;
--source include/restart_mysqld.inc
SET GLOBAL innodb_file_per_table=0;
SELECT NAME FROM information_schema.innodb_sys_tables WHERE SPACE = 0;
CREATE TABLE t2(f1 INT NOT NULL)ENGINE=InnoDB;

set global innodb_fast_shutdown=0;
let $restart_parameters=--debug_dbug=d,unused_undo_free_fail_3;
--source include/restart_mysqld.inc
SET GLOBAL innodb_file_per_table=0;
SELECT NAME FROM information_schema.innodb_sys_tables WHERE SPACE = 0;
CREATE TABLE t3(f1 INT NOT NULL)ENGINE=InnoDB;

set global innodb_fast_shutdown=0;
let $restart_parameters=--debug_dbug=d,unused_undo_free_fail_4;
--source include/restart_mysqld.inc
SET GLOBAL innodb_file_per_table=0;
SELECT NAME FROM information_schema.innodb_sys_tables WHERE SPACE = 0;
CREATE TABLE t4(f1 INT NOT NULL)ENGINE=InnoDB;

set global innodb_fast_shutdown=0;
let $restart_parameters=--debug_dbug=d,unused_undo_free_fail_5;
--source include/restart_mysqld.inc
SET GLOBAL innodb_file_per_table=0;
SELECT NAME FROM information_schema.innodb_sys_tables WHERE SPACE = 0;
DROP TABLE t1, t2, t3, t4;
set GLOBAL innodb_fast_shutdown=0;
let $restart_parameters=;
--source include/restart_mysqld.inc
SELECT NAME, FILE_SIZE FROM information_schema.innodb_sys_tablespaces WHERE SPACE = 0;
